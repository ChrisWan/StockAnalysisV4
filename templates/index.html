<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Portfolio Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .dashboard-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            margin: 20px;
            padding: 30px;
        }        .stock-selector {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        .stock-selector option {
            background: white;
            color: #333;
            padding: 10px;
            font-weight: normal;
        }
        .stock-selector option:hover {
            background: #f0f8ff;
        }
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .recommendation-badge {
            font-size: 18px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
            margin: 10px 0;
        }
        .buy { background: #4CAF50; color: white; }
        .sell { background: #f44336; color: white; }
        .hold { background: #ff9800; color: white; }
        .strong-buy { background: #2E7D32; color: white; }
        .strong-sell { background: #D32F2F; color: white; }
        .score-excellent { color: #4CAF50; font-weight: bold; }
        .score-good { color: #8BC34A; font-weight: bold; }
        .score-average { color: #FF9800; font-weight: bold; }
        .score-below-average { color: #FF5722; font-weight: bold; }
        .score-poor { color: #F44336; font-weight: bold; }
        .loading {
            text-align: center;
            padding: 50px;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        .metric-label {
            font-weight: 600;
            color: #555;
        }
        .metric-value {
            font-weight: bold;
            color: #333;
        }        .header-title {
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
        }
        .portfolio-management {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        .btn-success, .btn-danger {
            border-radius: 0 10px 10px 0;
        }        .form-control, .form-select {
            border-radius: 10px 0 0 10px;
        }
        .btn-outline-primary, .btn-outline-danger {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-outline-primary:hover, .btn-outline-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        #portfolioManagement {
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="dashboard-container">
            <h1 class="header-title">
                <i class="fas fa-chart-line"></i> Stock Portfolio Analysis Dashboard
            </h1>
            
            <!-- Stock Selector -->
            <div class="row mb-4">
                <div class="col-md-6 offset-md-3">
                    <label for="stockSelect" class="form-label h5">
                        <i class="fas fa-search"></i> Select Stock from Portfolio:
                    </label>                    <select class="form-select stock-selector" id="stockSelect">
                        <option value="">Choose a stock...</option>
                        {% for stock in stocks %}
                        <option value="{{ stock.symbol }}">{{ stock.symbol }} - {{ stock.name }}</option>
                        {% endfor %}
                    </select>
                </div>            </div>

            <!-- Portfolio Management Toggle -->
            <div class="row mb-4">
                <div class="col-md-12 text-right">
                    <button class="btn btn-outline-primary mr-2" id="togglePortfolioBtn" onclick="togglePortfolioManagement()">
                        <i class="fas fa-cog"></i> Manage Portfolio
                    </button>
                    <button class="btn btn-outline-primary" onclick="toggleBenchmarkManagement()">
                        <i class="fas fa-database"></i> Manage Sector Benchmarks
                    </button>
                </div>
            </div>

            <!-- Portfolio Management Section (Hidden by default) -->
            <div class="row mb-4" id="portfolioManagement" style="display: none;">
                <div class="col-md-6">
                    <div class="metric-card">
                        <h5><i class="fas fa-plus"></i> Add Stock to Portfolio</h5>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newStock" placeholder="Enter stock symbol (e.g., TSLA)" style="text-transform: uppercase;">
                            <button class="btn btn-success" id="addStockBtn" onclick="addStock()">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <small class="text-muted">Enter a valid stock ticker symbol</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="metric-card">
                        <h5><i class="fas fa-trash"></i> Remove Stock from Portfolio</h5>
                        <div class="input-group">
                            <select class="form-select" id="removeStock">
                                <option value="">Select stock to remove...</option>
                                {% for stock in stocks %}
                                <option value="{{ stock.symbol }}">{{ stock.symbol }} - {{ stock.name }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-danger" id="removeStockBtn" onclick="removeStock()">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                        <small class="text-muted">Select a stock to remove from your portfolio</small>
                    </div>
                </div>
            </div>

            <!-- Benchmark Management Panel (Hidden by default) -->
            <div class="row mb-4" id="benchmarkManagement" style="display: none;">
                <div class="col-md-12">
                    <div class="metric-card">
                        <h5><i class="fas fa-database"></i> Sector Benchmark Management</h5>
                        <p class="text-muted">Sector medians are calculated from representative stocks and saved to a file for optimal performance.</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="refreshBenchmarks()">
                                    <i class="fas fa-calculator"></i> Calculate & Save Benchmarks
                                </button>
                                <button class="btn btn-info ms-2" onclick="getBenchmarkStatus()">
                                    <i class="fas fa-info-circle"></i> Check Status
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info py-2 mb-0">
                                    <small>
                                        <strong>Note:</strong> This process analyzes 110 stocks across 11 sectors. 
                                        Takes 2-3 minutes but only needs to be done occasionally.
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div id="benchmarkStatus" class="mt-3" style="display: none;">
                            <h6>Benchmark Status:</h6>
                            <div id="benchmarkStatusContent"></div>
                        </div>
                        
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>How it works:</strong> The system fetches data for 10 representative stocks per sector, 
                                calculates the median for P/E, P/B, P/S, ROE, and Profit Margin, 
                                then saves the results to <code>sector_benchmarks.json</code> for fast access.
                                Stocks are scored based on how much better/worse they are compared to their sector median.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div id="loadingSpinner" class="loading" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Fetching stock data...</p>
            </div>

            <!-- Stock Analysis Container -->
            <div id="stockAnalysis" style="display: none;">
                <!-- Stock Header -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <h2 id="stockTitle" class="mb-0"></h2>
                        <p id="stockInfo" class="text-muted"></p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div id="overallRecommendation"></div>
                        <small id="lastUpdated" class="text-muted"></small>
                    </div>
                </div>

                <!-- Fundamental Analysis Section -->
                <div class="row">
                    <div class="col-md-8">
                        <div class="metric-card">
                            <h3><i class="fas fa-calculator"></i> Fundamental Analysis</h3>
                            
                            <!-- Key Metrics Grid -->
                            <div class="metric-grid" id="fundamentalMetrics">
                                <!-- Metrics will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <div class="metric-card">
                            <h4><i class="fas fa-chart-line"></i> Fundamental Analysis</h4>
                            <small class="text-muted">Clear comparison with sector peers and growth metrics</small>
                            
                            <!-- Sector Comparison Section -->
                            <div class="mt-3" id="sectorComparison" style="display: none;">
                                <h5><i class="fas fa-balance-scale"></i> Sector Comparison</h5>
                                <p class="text-muted">How this company compares to its sector peers</p>
                                <div id="sectorComparisonContent"></div>
                            </div>
                            
                            <!-- Growth Analysis Section -->
                            <div class="mt-4" id="growthAnalysis" style="display: none;">
                                <h5><i class="fas fa-trending-up"></i> Growth Analysis</h5>
                                <p class="text-muted">Company's own growth performance</p>
                                <div id="growthAnalysisContent"></div>
                            </div>
                            
                            <!-- Financial Health Section -->
                            <div class="mt-4" id="financialHealth" style="display: none;">
                                <h5><i class="fas fa-heartbeat"></i> Financial Health</h5>
                                <p class="text-muted">Key financial stability indicators</p>
                                <div id="financialHealthContent"></div>
                            </div>
                            
                            <div id="fundamentalAnalysis"></div>
                            
                            <div class="mt-3">
                                <strong>Technical Recommendation:</strong>
                                <div id="technicalRecommendation"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Technical Analysis Charts -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="chart-container">
                            <h3><i class="fas fa-chart-area"></i> Technical Analysis & Momentum Indicators</h3>
                            <div id="loadingChart" class="loading" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading chart...</span>
                                </div>
                                <p class="mt-3">Generating technical analysis charts...</p>
                            </div>
                            <div id="chartContainer"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const stockSelect = document.getElementById('stockSelect');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const stockAnalysis = document.getElementById('stockAnalysis');
            const loadingChart = document.getElementById('loadingChart');

            stockSelect.addEventListener('change', function() {
                const selectedStock = this.value;
                if (selectedStock) {
                    loadStockData(selectedStock);
                } else {
                    stockAnalysis.style.display = 'none';
                }
            });

            function loadStockData(stock) {
                // Show loading spinner
                loadingSpinner.style.display = 'block';
                stockAnalysis.style.display = 'none';

                // Fetch stock data
                fetch(`/api/stock/${stock}`)
                    .then(response => response.json())
                    .then(data => {
                        displayStockData(data);
                        loadChart(stock);
                        loadingSpinner.style.display = 'none';
                        stockAnalysis.style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        loadingSpinner.style.display = 'none';
                        alert('Error loading stock data. Please try again.');
                    });
            }

            function loadChart(stock) {
                loadingChart.style.display = 'block';
                document.getElementById('chartContainer').innerHTML = '';

                fetch(`/api/chart/${stock}`)
                    .then(response => response.json())
                    .then(data => {
                        loadingChart.style.display = 'none';
                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${data.chart}`;
                        img.style.width = '100%';
                        img.style.height = 'auto';
                        document.getElementById('chartContainer').appendChild(img);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        loadingChart.style.display = 'none';
                        document.getElementById('chartContainer').innerHTML = '<p class="text-danger">Error loading chart</p>';
                    });
            }

            function displayStockData(data) {
                // Update stock title
                document.getElementById('stockTitle').textContent = data.symbol;
                document.getElementById('stockInfo').textContent = 
                    `${data.fundamental_metrics.sector || 'N/A'} - ${data.fundamental_metrics.industry || 'N/A'}`;
                document.getElementById('lastUpdated').textContent = `Last updated: ${data.last_updated}`;

                // Update overall recommendation
                const overallRec = document.getElementById('overallRecommendation');
                overallRec.innerHTML = `<span class="recommendation-badge ${getRecommendationClass(data.overall_recommendation)}">${data.overall_recommendation}</span>`;

                // Update fundamental metrics
                const metricsContainer = document.getElementById('fundamentalMetrics');
                metricsContainer.innerHTML = '';

                const keyMetrics = [
                    ['Market Cap', 'market_cap'],
                    ['Current Price', 'current_price'],
                    ['P/E Ratio', 'pe_ratio'],
                    ['Forward P/E', 'forward_pe'],
                    ['Price/Book', 'price_to_book'],
                    ['Price/Sales', 'price_to_sales'],
                    ['PEG Ratio', 'peg_ratio'],
                    ['Profit Margin', 'profit_margin'],
                    ['Operating Margin', 'operating_margin'],
                    ['ROE', 'return_on_equity'],
                    ['ROA', 'return_on_assets'],
                    ['Revenue Growth', 'revenue_growth'],
                    ['Earnings Growth', 'earnings_growth'],
                    ['Debt/Equity', 'debt_to_equity'],
                    ['Current Ratio', 'current_ratio'],
                    ['Beta', 'beta'],
                    ['Dividend Yield', 'dividend_yield'],
                    ['52W High', '52_week_high'],
                    ['52W Low', '52_week_low']
                ];

                keyMetrics.forEach(([label, key]) => {
                    const metricDiv = document.createElement('div');
                    metricDiv.className = 'metric-item';
                    metricDiv.innerHTML = `
                        <span class="metric-label">${label}:</span>
                        <span class="metric-value">${data.fundamental_metrics[key] || 'N/A'}</span>
                    `;
                    metricsContainer.appendChild(metricDiv);
                });

                // Update fundamental analysis
                const analysis = data.fundamental_analysis;
                
                // Show sector comparison
                if (analysis.sector_comparison && Object.keys(analysis.sector_comparison.metrics || {}).length > 0) {
                    document.getElementById('sectorComparison').style.display = 'block';
                    updateSectorComparison(analysis.sector_comparison);
                }
                
                // Show growth analysis
                if (analysis.growth_analysis && Object.keys(analysis.growth_analysis.metrics || {}).length > 0) {
                    document.getElementById('growthAnalysis').style.display = 'block';
                    updateGrowthAnalysis(analysis.growth_analysis);
                }
                
                // Show financial health
                if (analysis.financial_health && Object.keys(analysis.financial_health).length > 0) {
                    document.getElementById('financialHealth').style.display = 'block';
                    updateFinancialHealth(analysis.financial_health);
                }

                // Update recommendations
                document.getElementById('technicalRecommendation').innerHTML = 
                    `<span class="recommendation-badge ${getRecommendationClass(data.technical_recommendation)}">${data.technical_recommendation}</span>`;
            }

            function getRecommendationClass(recommendation) {
                switch(recommendation) {
                    case 'STRONG BUY': return 'strong-buy';
                    case 'BUY': return 'buy';
                    case 'HOLD': return 'hold';
                    case 'SELL': return 'sell';
                    case 'STRONG SELL': return 'strong-sell';
                    default: return 'hold';
                }
            }

            // Functions to update the new analysis sections
            function updateSectorComparison(sectorData) {
                const container = document.getElementById('sectorComparisonContent');
                let html = `<h6>Sector: ${sectorData.sector_name}</h6>`;
                html += '<div class="table-responsive"><table class="table table-sm">';
                html += '<thead><tr><th>Metric</th><th>Company</th><th>Sector Median</th><th>Status</th></tr></thead><tbody>';
                
                for (const [key, metric] of Object.entries(sectorData.metrics)) {
                    const betterClass = metric.better_than_sector ? 'text-success' : 'text-danger';
                    const betterIcon = metric.better_than_sector ? '✅' : '❌';
                    
                    html += `
                        <tr>
                            <td><strong>${metric.label}</strong></td>
                            <td class="${betterClass}">${metric.company_value}</td>
                            <td>${metric.sector_median}</td>
                            <td class="${betterClass}">${betterIcon}</td>
                        </tr>
                    `;
                }
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
            }

            function updateGrowthAnalysis(growthData) {
                const container = document.getElementById('growthAnalysisContent');
                let html = '<div class="row">';
                
                for (const [key, metric] of Object.entries(growthData.metrics)) {
                    const growthClass = metric.raw_value >= 0.05 ? 'text-success' : 
                                      metric.raw_value >= 0 ? 'text-warning' : 'text-danger';
                    
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="border rounded p-3">
                                <h6>${metric.label}</h6>
                                <h4 class="${growthClass}">${metric.value}</h4>
                                <small class="text-muted">${metric.interpretation}</small>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
            }

            function updateFinancialHealth(healthData) {
                const container = document.getElementById('financialHealthContent');
                let html = '<div class="row">';
                
                for (const [key, metric] of Object.entries(healthData)) {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="border rounded p-3">
                                <h6>${metric.label}</h6>
                                <h5>${metric.value}</h5>
                                <small class="text-muted">${metric.interpretation}</small>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                container.innerHTML = html;
            }

            function getScoreClass(ranking) {
                switch(ranking) {
                    case 'EXCELLENT': return 'score-excellent';
                    case 'GOOD': return 'score-good';
                    case 'AVERAGE': return 'score-average';
                    case 'BELOW_AVERAGE': return 'score-below-average';
                    case 'POOR': return 'score-poor';
                    default: return 'score-average';                }
            }
        });        // Portfolio Management Functions
        window.togglePortfolioManagement = function() {
            const portfolioSection = document.getElementById('portfolioManagement');
            const toggleBtn = document.getElementById('togglePortfolioBtn');
            
            if (portfolioSection.style.display === 'none') {
                portfolioSection.style.display = 'flex';
                toggleBtn.innerHTML = '<i class="fas fa-times"></i> Close Portfolio Management';
                toggleBtn.className = 'btn btn-outline-danger mr-2';
            } else {
                portfolioSection.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-cog"></i> Manage Portfolio';
                toggleBtn.className = 'btn btn-outline-primary mr-2';
            }
        };

        window.reloadPortfolioDropdowns = function() {
            // Fetch updated portfolio
            fetch('/api/portfolio')
                .then(response => response.json())
                .then(data => {
                    const stockSelect = document.getElementById('stockSelect');
                    const removeStock = document.getElementById('removeStock');
                    
                    // Clear existing options
                    stockSelect.innerHTML = '<option value="">Choose a stock...</option>';
                    removeStock.innerHTML = '<option value="">Select stock to remove...</option>';
                    
                    // Add updated portfolio stocks
                    data.portfolio.forEach(stock => {
                        const option1 = document.createElement('option');
                        option1.value = stock.symbol;
                        option1.textContent = `${stock.symbol} - ${stock.name}`;
                        stockSelect.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = stock.symbol;
                        option2.textContent = `${stock.symbol} - ${stock.name}`;
                        removeStock.appendChild(option2);
                    });
                })
                .catch(error => {
                    console.error('Error reloading portfolio:', error);
                });
        };

        window.addStock = function() {
            const newStock = document.getElementById('newStock').value.trim().toUpperCase();
            if (!newStock) {
                alert('Please enter a stock symbol');
                return;
            }

            const addBtn = document.getElementById('addStockBtn');
            addBtn.disabled = true;
            addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';            fetch('/api/portfolio/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ symbol: newStock })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                } else {
                    alert(data.message);
                    reloadPortfolioDropdowns(); // Reload dropdowns instead of entire page
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding stock to portfolio');
            })
            .finally(() => {
                addBtn.disabled = false;
                addBtn.innerHTML = '<i class="fas fa-plus"></i> Add';
                document.getElementById('newStock').value = '';
            });
        };

        window.removeStock = function() {
            const stockToRemove = document.getElementById('removeStock').value;
            if (!stockToRemove) {
                alert('Please select a stock to remove');
                return;
            }

            if (!confirm(`Are you sure you want to remove ${stockToRemove} from your portfolio?`)) {
                return;
            }

            const removeBtn = document.getElementById('removeStockBtn');
            removeBtn.disabled = true;
            removeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';            fetch('/api/portfolio/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ symbol: stockToRemove })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                } else {
                    alert(data.message);
                    reloadPortfolioDropdowns(); // Reload dropdowns instead of entire page
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error removing stock from portfolio');
            })
            .finally(() => {
                removeBtn.disabled = false;
                removeBtn.innerHTML = '<i class="fas fa-trash"></i> Remove';
                document.getElementById('removeStock').value = '';
            });
        };

        // Benchmark Management Functions
        window.toggleBenchmarkManagement = function() {
            const panel = document.getElementById('benchmarkManagement');
            const toggleBtn = document.querySelector('button[onclick="toggleBenchmarkManagement()"]');
            
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-times"></i> Close Benchmarks';
                toggleBtn.className = 'btn btn-outline-danger';
            } else {
                panel.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-database"></i> Manage Sector Benchmarks';
                toggleBtn.className = 'btn btn-outline-primary';
            }
        };

        window.refreshBenchmarks = function() {
            const btn = document.querySelector('button[onclick="refreshBenchmarks()"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';

            // Show progress message
            const statusDiv = document.getElementById('benchmarkStatus');
            const contentDiv = document.getElementById('benchmarkStatusContent');
            contentDiv.innerHTML = '<div class="alert alert-info">Calculating sector benchmarks... This may take 2-3 minutes.</div>';
            statusDiv.style.display = 'block';

            fetch('/api/benchmarks/refresh', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`Error: ${data.error}`);
                    contentDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                } else {
                    alert(`Benchmark calculation completed!\nSectors: ${data.total_sectors}\nFile: ${data.file_saved}\nLast updated: ${data.last_updated}`);
                    getBenchmarkStatus(); // Refresh status display
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error calculating benchmarks');
                contentDiv.innerHTML = '<div class="alert alert-danger">Error calculating benchmarks</div>';
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-calculator"></i> Calculate & Save Benchmarks';
            });
        };

        window.getBenchmarkStatus = function() {
            const statusDiv = document.getElementById('benchmarkStatus');
            const contentDiv = document.getElementById('benchmarkStatusContent');
            const toggleBtn = document.querySelector('button[onclick="getBenchmarkStatus()"]');
            
            // Check if status is currently visible
            if (statusDiv.style.display === 'block') {
                // Hide the status
                statusDiv.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-info-circle"></i> Check Status';
                toggleBtn.className = 'btn btn-info ms-2';
                return;
            }
            
            // Show loading state
            toggleBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            toggleBtn.disabled = true;
            
            fetch('/api/benchmarks/status')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    contentDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                } else {
                    const fileStatus = data.file_status;
                    const benchmarkData = data.benchmark_data;
                    const stockData = data.representative_stocks;
                    
                    let html = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>File Status:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>File:</strong> ${fileStatus.path}</li>
                                    <li><strong>Exists:</strong> <span class="badge ${fileStatus.exists ? 'bg-success' : 'bg-danger'}">${fileStatus.exists ? 'Yes' : 'No'}</span></li>
                                    <li><strong>Last Modified:</strong> ${fileStatus.last_modified}</li>
                                    <li><strong>Size:</strong> ${fileStatus.size}</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Benchmark Data:</h6>
                                <ul class="list-unstyled">
                                    <li><strong>Sectors:</strong> ${benchmarkData.total_sectors}</li>
                                    <li><strong>Last Calculated:</strong> ${benchmarkData.last_calculated}</li>
                                    <li><strong>Method:</strong> ${benchmarkData.calculation_method}</li>
                                    <li><strong>Using Fallback:</strong> <span class="badge ${benchmarkData.using_fallback ? 'bg-warning' : 'bg-success'}">${benchmarkData.using_fallback ? 'Yes' : 'No'}</span></li>
                                </ul>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-12">
                                <h6>Representative Stocks:</h6>
                                <p><strong>Total:</strong> ${stockData.total_stocks} stocks across ${benchmarkData.total_sectors} sectors</p>
                                <details>
                                    <summary>View stocks per sector</summary>
                                    <div class="mt-2">
                    `;
                    
                    for (const [sector, count] of Object.entries(stockData.stocks_per_sector)) {
                        html += `<span class="badge bg-secondary me-1 mb-1">${sector}: ${count} stocks</span>`;
                    }
                    
                    html += `
                                    </div>
                                </details>
                            </div>
                        </div>
                    `;
                    
                    contentDiv.innerHTML = html;
                }
                
                // Show the status and update button
                statusDiv.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Status';
                toggleBtn.className = 'btn btn-outline-info ms-2';
                toggleBtn.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                contentDiv.innerHTML = '<div class="alert alert-danger">Error fetching benchmark status</div>';
                statusDiv.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Status';
                toggleBtn.className = 'btn btn-outline-info ms-2';
                toggleBtn.disabled = false;
            });
        };

        // Allow Enter key to add stock
        document.getElementById('newStock').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addStock();
            }
        });
    </script>
</body>
</html>
